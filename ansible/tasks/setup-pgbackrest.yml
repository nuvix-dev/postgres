- name: Create pgBackRest group
  ansible.builtin.group:
    name: pgbackrest
    state: present
  when:
    - nixpkg_mode

- name: Create pgBackRest user
  ansible.builtin.user:
    comment: pgBackRest user
    group: pgbackrest
    groups: pgbackrest, postgres
    home: /var/lib/pgbackrest
    name: pgbackrest
    shell: /sbin/nologin
    system: true
  when:
    - nixpkg_mode

- name: Configure sudoers for pgBackRest
  ansible.builtin.lineinfile:
    create: yes
    line: "{{ item }}"
    mode: '0440'
    path: '/etc/sudoers.d/pgbackrest'
    validate: 'visudo -cf %s'
  loop:
    - 'postgres ALL=(pgbackrest) NOPASSWD: /var/lib/pgbackrest/.nix-profile/bin/pgbackrest'
    - 'postgres ALL=(pgbackrest) NOPASSWD: /usr/bin/pgbackrest'
    - 'postgres ALL=(pgbackrest) NOPASSWD: /usr/bin/bash'
    - 'postgres ALL=(pgbackrest) NOPASSWD: /usr/bin/nix'
    - 'pgbackrest ALL=(pgbackrest) NOPASSWD: /usr/bin/bash'

- name: Install pgBackRest
  ansible.builtin.shell: |
    sudo -u pgbackrest bash -c ". /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh && nix profile install github:supabase/postgres/{{ git_commit_sha }}#pg-backrest"
  become: true
  become_user: pgbackrest
  changed_when: true
  when:
    - stage2_nix

- name: Create needed directories for pgBackRest
  ansible.legacy.file:
    group: postgres
    mode: '0770'
    owner: pgbackrest
    path: "{{ backrest_dir }}"
    state: directory
  loop:
    - /etc/pgbackrest/conf.d
    - /var/lib/pgbackrest
    - /var/spool/pgbackrest
    - /var/log/pgbackrest
  loop_control:
    loop_var: backrest_dir
  when:
    - nixpkg_mode

- name: Symlink pgbackrest.conf
  ansible.legacy.file:
    force: true
    path: /etc/pgbackrest/pgbackrest.conf
    src: /etc/pgbackrest.conf
    state: link

- name: Move pgBackRest files to /etc/pgbackrest
  ansible.legacy.copy:
    group: postgres
    dest: "/etc/pgbackrest/{{ conf_item['path'] }}/{{ conf_item['name'] }}"
    mode: '0640'
    owner: pgbackrest
    src: "files/pgbackrest_config/{{ conf_item['name'] }}"
  loop:
    - {name: computed_globals.conf, path: conf.d}
    - {name: pgbackrest.conf, path: ''}
    - {name: repo1_async.conf, path: conf.d}
    - {name: repo1_encrypted.conf, path: conf.d}
    - {name: repo1.conf, path: conf.d}
  loop_control:
    loop_var: conf_item
  when:
    - stage2_nix

- name: Create pgBackRest wrapper script
  ansible.builtin.copy:
    content: |
      #!/bin/bash
      # Sanitize dangerous arguments
      sanitized_args=()
      while [[ $# -gt 0 ]]; do
        case "$1" in
          --cmd=*|--cmd)
            # Skip --cmd and its value
            [[ "$1" == "--cmd" ]] && shift
            shift || true
            ;;
          --ssh-cmd=*|--ssh-cmd)
            # Skip --ssh-cmd and its value
            [[ "$1" == "--ssh-cmd" ]] && shift
            shift || true
            ;;
          --repo-host-cmd=*|--repo-host-cmd)
            # Skip --repo-host-cmd and its value
            [[ "$1" == "--repo-host-cmd" ]] && shift
            shift || true
            ;;
          --config=*|--config)
            # Skip --config and its value
            [[ "$1" == "--config" ]] && shift
            shift || true
            ;;
          *)
            sanitized_args+=("$1")
            shift
            ;;
        esac
      done
      exec sudo -u pgbackrest /var/lib/pgbackrest/.nix-profile/bin/pgbackrest "${sanitized_args[@]}"
    dest: '/usr/bin/pgbackrest'
    group: 'root'
    mode: '0755'
    owner: 'root'
